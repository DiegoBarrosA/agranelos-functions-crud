name: CI - Build and Test

on:
  push:
    branches: [ main, develop, sumativa-3-staging ]
  pull_request:
    branches: [ main, develop, sumativa-3-staging ]
  workflow_dispatch:

env:
  JAVA_VERSION: '11'

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_SSL_MODE: 'disable'
    
    steps:
    - name: 'ğŸ“¥ Checkout repository'
      uses: actions/checkout@v3

    - name: 'â˜• Setup Java JDK ${{ env.JAVA_VERSION }}'
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: 'ğŸ” Display Maven version'
      run: mvn -version

    - name: 'ğŸ“¦ Build with Maven'
      run: |
        echo "Building the project..."
        mvn clean package -DskipTests
        echo "âœ… Build completed successfully!"

    - name: 'ğŸ“‚ List build artifacts'
      run: |
        echo "Contents of target directory:"
        ls -lh target/
        echo ""
        echo "Contents of azure-functions directory:"
        ls -lh target/azure-functions/

    - name: 'âœ… Build Summary'
      if: success()
      run: |
        echo "================================"
        echo "âœ… BUILD SUCCESSFUL"
        echo "================================"
        echo "Java Version: ${{ env.JAVA_VERSION }}"
        echo "Maven Build: SUCCESS"
        echo "Artifacts: Generated in target/"
        echo "================================"

    - name: 'âŒ Build Failed'
      if: failure()
      run: |
        echo "================================"
        echo "âŒ BUILD FAILED"
        echo "================================"
        echo "Please check the logs above for details"
        echo "================================"

  verify-structure:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: 'ğŸ“¥ Checkout repository'
      uses: actions/checkout@v3

    - name: 'â˜• Setup Java JDK ${{ env.JAVA_VERSION }}'
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: 'ğŸ“¦ Build project'
      run: mvn clean package -DskipTests

    - name: 'ğŸ” Verify Azure Functions structure'
      run: |
        echo "Verifying Azure Functions structure..."
        
        FUNCTION_DIR="target/azure-functions/inventario-functions-create-20250830112014764"
        
        if [ ! -d "$FUNCTION_DIR" ]; then
          echo "âŒ Azure Functions directory not found!"
          exit 1
        fi
        
        echo "âœ… Azure Functions directory exists"
        
        # Check for required files
        files=("host.json" "local.settings.json" "inventario-functions-create-1.0-SNAPSHOT.jar")
        for file in "${files[@]}"; do
          if [ -f "$FUNCTION_DIR/$file" ]; then
            echo "âœ… $file found"
          else
            echo "âŒ $file not found"
            exit 1
          fi
        done
        
        # Check for function directories
        functions=("CreateProducto" "GetProductos" "GetProductoById" "UpdateProducto" "DeleteProducto" 
                   "CreateBodega" "GetBodegas" "GetBodegaById" "UpdateBodega" "DeleteBodega" 
                   "GraphQL" "InitializeDatabase")
        
        for func in "${functions[@]}"; do
          if [ -d "$FUNCTION_DIR/$func" ]; then
            echo "âœ… Function $func exists"
            if [ -f "$FUNCTION_DIR/$func/function.json" ]; then
              echo "  âœ… function.json found"
            else
              echo "  âŒ function.json not found"
              exit 1
            fi
          else
            echo "âŒ Function $func not found"
            exit 1
          fi
        done
        
        echo ""
        echo "================================"
        echo "âœ… ALL VERIFICATIONS PASSED"
        echo "================================"

  check-event-grid-integration:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: 'ğŸ“¥ Checkout repository'
      uses: actions/checkout@v3

    - name: 'ğŸ” Verify Event Grid integration files'
      run: |
        echo "Checking Event Grid integration..."
        
        # Check event classes
        if [ -f "src/main/java/com/agranelos/inventario/events/EventType.java" ]; then
          echo "âœ… EventType.java exists"
        else
          echo "âŒ EventType.java not found"
          exit 1
        fi
        
        if [ -f "src/main/java/com/agranelos/inventario/events/EventGridPublisher.java" ]; then
          echo "âœ… EventGridPublisher.java exists"
        else
          echo "âŒ EventGridPublisher.java not found"
          exit 1
        fi
        
        if [ -f "src/main/java/com/agranelos/inventario/events/EventGridConsumer.java" ]; then
          echo "âœ… EventGridConsumer.java exists"
        else
          echo "âŒ EventGridConsumer.java not found"
          exit 1
        fi
        
        if [ -f "src/main/java/com/agranelos/inventario/events/ProductoEventData.java" ]; then
          echo "âœ… ProductoEventData.java exists"
        else
          echo "âŒ ProductoEventData.java not found"
          exit 1
        fi
        
        if [ -f "src/main/java/com/agranelos/inventario/events/BodegaEventData.java" ]; then
          echo "âœ… BodegaEventData.java exists"
        else
          echo "âŒ BodegaEventData.java not found"
          exit 1
        fi
        
        echo ""
        echo "================================"
        echo "âœ… EVENT GRID FILES VERIFIED"
        echo "================================"

  check-dependencies:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: 'ğŸ“¥ Checkout repository'
      uses: actions/checkout@v3

    - name: 'â˜• Setup Java JDK ${{ env.JAVA_VERSION }}'
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: 'ğŸ” Check Maven dependencies'
      run: |
        echo "Checking Maven dependencies..."
        mvn dependency:tree
        
        echo ""
        echo "Verifying critical dependencies..."
        
        # Check for Azure Event Grid
        if mvn dependency:tree | grep -q "azure-messaging-eventgrid"; then
          echo "âœ… Azure Event Grid dependency found"
        else
          echo "âŒ Azure Event Grid dependency not found"
          exit 1
        fi
        
        # Check for Azure Identity
        if mvn dependency:tree | grep -q "azure-identity"; then
          echo "âœ… Azure Identity dependency found"
        else
          echo "âŒ Azure Identity dependency not found"
          exit 1
        fi
        
        # Check for PostgreSQL
        if mvn dependency:tree | grep -q "postgresql"; then
          echo "âœ… PostgreSQL dependency found"
        else
          echo "âŒ PostgreSQL dependency not found"
          exit 1
        fi
        
        # Check for GraphQL
        if mvn dependency:tree | grep -q "graphql-java"; then
          echo "âœ… GraphQL dependency found"
        else
          echo "âŒ GraphQL dependency not found"
          exit 1
        fi
        
        echo ""
        echo "================================"
        echo "âœ… ALL DEPENDENCIES VERIFIED"
        echo "================================"

  documentation-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: 'ğŸ“¥ Checkout repository'
      uses: actions/checkout@v3

    - name: 'ğŸ“š Verify documentation files'
      run: |
        echo "Checking documentation..."
        
        files=("README.md" "docs/ARQUITECTURA.md" "docs/DEPLOY.md" 
               "azure-deploy.json" "azure-deploy.parameters.json" 
               "scripts/deploy-azure.sh")
        
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file not found"
            exit 1
          fi
        done
        
        # Check if deploy script is executable
        if [ -x "scripts/deploy-azure.sh" ]; then
          echo "âœ… deploy-azure.sh is executable"
        else
          echo "âš ï¸ deploy-azure.sh is not executable (will be fixed in deployment)"
        fi
        
        echo ""
        echo "================================"
        echo "âœ… DOCUMENTATION VERIFIED"
        echo "================================"

  summary:
    runs-on: ubuntu-latest
    needs: [build, verify-structure, check-event-grid-integration, check-dependencies, documentation-check]
    if: always()
    
    steps:
    - name: 'ğŸ“Š Test Summary'
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘          CI/CD PIPELINE - TEST SUMMARY                    â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Repository: agranelos-functions-crud"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Triggered by: ${{ github.event_name }}"
        echo ""
        echo "Jobs Status:"
        echo "  â€¢ Build: ${{ needs.build.result }}"
        echo "  â€¢ Verify Structure: ${{ needs.verify-structure.result }}"
        echo "  â€¢ Event Grid Integration: ${{ needs.check-event-grid-integration.result }}"
        echo "  â€¢ Dependencies Check: ${{ needs.check-dependencies.result }}"
        echo "  â€¢ Documentation Check: ${{ needs.documentation-check.result }}"
        echo ""
        
        if [ "${{ needs.build.result }}" == "success" ] && \
           [ "${{ needs.verify-structure.result }}" == "success" ] && \
           [ "${{ needs.check-event-grid-integration.result }}" == "success" ] && \
           [ "${{ needs.check-dependencies.result }}" == "success" ] && \
           [ "${{ needs.documentation-check.result }}" == "success" ]; then
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘               âœ… ALL TESTS PASSED!                         â•‘"
          echo "â•‘          Sistema listo para despliegue en Azure            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 0
        else
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘               âŒ SOME TESTS FAILED                         â•‘"
          echo "â•‘          Por favor revisa los logs anteriores              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
        fi
